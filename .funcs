#!/bin/bash

die() { echo $@; exit -1; }

# Misc.
rand-cd() {
  local DIRS; DIRS=$(find . -maxdepth 1 -type d | sed 's/\(.*\)/"\1"/g')
  local NUM_DIRS=$(echo $DIRS | wc -l)
  [[ $NUM_DIRS == 1 ]] && die "Error: No directories found."
  cd "$(echo $DIRS | xargs -n $NUM_DIRS shuf -n1 -e)"
}
alias rcd='rand-cd'

wget-rec() {
  wget --recursive \
    --page-requisites \
    --html-extension \
    --convert-links \
    --no-parent \
    $*
}

d2h() { # diff2html
  local TMP_FILE=$(mktemp -t hdiff.XXXX)
  diff2html $@ > $TMP_FILE
  chromium $TMP_FILE
}

calc() { echo "scale=10; $@" | bc }
mkdircd() { mkdir $1; cd $1; }

# Netjoin - Block until a network connection is obtained.
nj() {
  while true; do
    ping -c 1 8.8.8.8 &> /dev/null && break
    sleep 1
  done
}

# Android.
musicToAndroid() {
  { adb devices | grep "device$" &> /dev/null } \
    || { echo "No devices found."; return; }
  while read SONG; do
    echo "Syncing $SONG."
    adb push $SONG /sdcard/Music &> /dev/null
    [[ $? != 0 ]] && echo " + Failed."
  done < <(find $* -type f | sort -R)
}
alias m2a='musicToAndroid'

syncepub() {
  { adb devices | grep "device$" &> /dev/null } \
    || { echo "No devices found."; return; }
  adb shell '[[ -d /sdcard/eBooks ]] || mkdir /sdcard/eBooks'
  while read BOOK; do
    echo "Syncing $BOOK."
    adb push $BOOK /sdcard/eBooks/ &> /dev/null
    [[ $? != 0 ]] && echo " + Failed."
  done < <(find $* -name '*.epub')
}
alias se='syncepub'

# Docker.
docker-clean() {
  docker rm $(docker ps -a -q)
  docker rmi $(docker images -q)
}

docker-zsh() {
  local TAG=$1
  docker run -v /tmp:/host_tmp:rw -i -t $TAG /bin/zsh
}

# Thread functions.
ps-threads() { ps -C $1 -L -opsr,pid,ppid,lwp,state }
watch-threads() { watch -n 1 ps -C $1 -L -opsr,pid,ppid,lwp,state }

# Allow crontab in dotfiles.
[ -z "${CRONTABCMD+x}" ] && export CRONTABCMD=$(which crontab)
[ -z "${CRONTABFILE+x}" ] && export CRONTABFILE=$HOME/.crontab.$HOST
crontab() {
  if [[ $@ == "-e" ]]; then vim $CRONTABFILE && $CRONTABCMD $CRONTABFILE
  else $CRONTABCMD $@; fi
}

# Infinitely loop a set of commands.
inf() {
  while true; do
    zsh -ci "source $HOME/.zshrc; $* ;"
    [[ $? == 0 ]] || return
  done;
}

pathadd() {
  if [ -d "$1" ] && [[ ":$PATH:" != *":$1:"* ]]; then
    PATH="${PATH:+"$PATH:"}$1"
  fi
}

# https://gist.github.com/lelandbatey/8677901
whiteboardCleaner() {
  convert $1 -morphology Convolve DoG:15,100,0 \
    -negate -normalize -blur 0x1 -channel RBG \
    -level 60%,91%,0.1 $2
}

memo() {
  echo "$*" | mail -n -s "$*" bdamos@vt.edu
}

lapack-install() {
  wget http://www.netlib.org/lapack/lapack-3.5.0.tgz -O /tmp/lapack.tgz
  tar xvfz /tmp/lapack.tgz -C ~
  rm -f /tmp/lapack.tgz
  cd ~/lapack-3.5.0
  cp make.inc{.example,}
  make -j8 lapacklib blaslib
  ln -s $PWD/librefblas.a libblas.a
}
